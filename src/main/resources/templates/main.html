<html lang="ko" layout:decorate="~{layout}">
<body>

<div layout:fragment="content"
     th:with="notebookList=${mainDataDto.notebookList},
        noteList=${mainDataDto.noteList},
        targetNotebook=${mainDataDto.targetNotebook},
        targetNote=${mainDataDto.targetNote},
        searchedNotebookList=${mainDataDto.searchedDataDto.searchedNotebookList},
        searchedNoteList=${mainDataDto.searchedDataDto.searchedNoteList},
        tagList=${mainDataDto.searchedDataDto.tagList},
">

    <div id="params" th:object="${paramModel}">
        <input type="hidden" name="keyword" th:field="*{keyword}">
        <input type="hidden" name="isSearch" th:field="*{isSearch}">
        <input type="hidden" name="isTagModal" th:field="*{isTagModal}">
        <input type="hidden" name="sort" th:field="*{sort}">
    </div>

    <dialog th:replace="~{fragment/modal::move}"/>
    <dialog th:replace="~{fragment/modal::search}"/>
    <dialog th:replace="~{fragment/modal::tag}"/>
    <dialog th:replace="~{fragment/modal::rename}"/>

    <div class="bg-blue-300">
        <a href="/">logo</a>
    </div>
    <div class="flex">
        <div class="bg-indigo-300 w-[20%]">
            <ul class="menu h-[100%] overflow-scroll">
                <li th:replace="~{fragment/note::noteTree(${notebookList}, ${targetNotebook})}">
            </ul>

            <form th:action="${@notebookUrlHandler.getWriteUrl()}" method="post">
                <input type="submit" value="추가" class="postActionBtn">
            </form>

            <form th:action="${@notebookUrlHandler.getSubWriteUrl(targetNotebook.id)}" method="post">
                <input type="submit" value="하위 노트북 추가" class="postActionBtn">
            </form>
            <form th:action="${@notebookUrlHandler.getDeleteUrl(targetNotebook.id)}" method="post">
                <input type="submit" value="삭제" class="postActionBtn">
            </form>
            <a href="/signup" class="btn">회원 가입</a>
            <a href="/logout" class="btn">로그아웃</a>

            <!-- Open the modal using ID.showModal() method -->
            <button class="btn" onclick="my_modal_4.showModal()">노트 이름 변경</button>
            <button class="btn" onclick="my_modal_1.showModal()">노트 이동</button>
            <button class="btn" onclick="my_modal_2.showModal()">검색</button>
            <button class="btn" onclick="my_modal_3.showModal()">태그 목록</button>

        </div>
        <div class="bg-red-300 w-[20%] h-[800px] text-center ">
            <ul class="h-[100%] overflow-scroll">
                <li th:each="note : ${noteList}" th:class="${note.id == targetNote.id} ? 'bg-blue-600' : ''">
                    <a th:href="${@noteUrlHandler.getDetailUrl(targetNotebook.id, note.id)}"
                       th:text="${note.title}"></a>
                </li>
            </ul>
            <form th:action="${@noteUrlHandler.getWriteUrl(targetNotebook.id)}" method="post">
                <input type="submit" value="추가" class="postActionBtn">
            </form>
            <a th:data-url="${@noteUrlHandler.getDetailUrl(targetNotebook.id, targetNote.id)}"
               id="sortDate"
               class="btn">
                날짜순
            </a>
            <a th:data-url="${@noteUrlHandler.getDetailUrl(targetNotebook.id, targetNote.id)}"
               id="sortTitle"
               class="btn">
                제목순
            </a>
        </div>

        <div class="w-[60%]">
            <form th:action="${@noteUrlHandler.getUpdateUrl(targetNotebook.id, targetNote.id)}" method="post"
                  id="updateForm">
                <div>
                    <input type="hidden" name="id" th:value="${targetNote.id}">
                </div>
                <div>
                    <input type="text" name="title" th:value="${targetNote.title}">
                </div>
                <input type="hidden" name="content" id="editor-body">
                <div id="editor"></div>
                <div>
                    <input type="button" value="수정" id="updateBtn">
                </div>
            </form>
            <form th:action="${@noteUrlHandler.getDeleteUrl(targetNotebook.id, targetNote.id)}" method="post"
                  id="deleteForm">
                <input type="button" value="삭제" id="deleteBtn">
            </form>
            <div>
                <ul class="flex gap-2">
                    <li th:each="noteTag : ${targetNote.noteTagList}">
                        <form th:action="@{|/notes/${targetNote.id}/tags/${noteTag.id}/delete|}" method="post">
                            <input type="submit" th:value="${noteTag.tag.name}" class="btn">
                        </form>
                    </li>
                </ul>
            </div>
            <form th:action="@{|/notes/${targetNote.id}/tags/create|}" method="post">
                <input type="text" name="name" class="input input-bordered" placeholder="태그 추가">
                <input type="submit" class="btn" value="추가">
            </form>
        </div>
    </div>
    <script th:inline="javascript">
        const Editor = toastui.Editor;
        const editor = new Editor({
            el: document.querySelector('#editor'),
            height: '700px',
            initialEditType: 'markdown',
            previewStyle: 'vertical',
            initialValue: [[${targetNote.content}]]
        });

        editor.getMarkdown();
    </script>
    <script>

        window.onload = function () {
            console.log("dfsdfsdf");
            const params = getDefaultParams();
            const isSearch = params.isSearch;
            const isTagModal = params.isTagModal;
            console.log(params);
            console.log(isSearch);
            console.log(isTagModal);
            if (Boolean(isSearch)) {
                const searchModal = document.getElementById("my_modal_2");
                searchModal.showModal();
            }

            if (Boolean(isTagModal)) {
                const tagModal = document.getElementById("my_modal_3");
                tagModal.showModal();
            }

            document.getElementById("updateBtn").addEventListener("click", updateForm);
            document.getElementById("deleteBtn").addEventListener("click", deleteForm);

            document.getElementById("sortDate").addEventListener("click", event => {
                event.preventDefault();

                getAction(event.target, (params) => {
                    params.sort = "date";
                });

            });

            document.getElementById("sortTitle").addEventListener("click", event => {
                event.preventDefault();
                getAction(event.target, (params) => {
                    params.sort = "title";
                });
            });

        }

        function updateForm(e) {
            const editorBody = document.getElementById("editor-body");
            if (confirm("수정하시겠습니까?")) {
                const text = editor.getMarkdown();
                editorBody.value = text;
                defaultPostAction(e.target);
            }
        }

        function deleteForm(e) {
            if (confirm("삭제하시겠습니까?")) {
                defaultPostAction(e.target);
            }

            document.querySelectorAll(".postActionBtn").forEach(btn => {
                btn.addEventListener("click", event => {
                    event.preventDefault();
                    postAction(event.target);
                });
            });

            document.querySelectorAll(".getActionBtn").forEach(btn => {
                btn.addEventListener("click", event => {
                    event.preventDefault();
                    getAction(event.target);
                });
            });
        }
    </script>

    <script th:replace="~{fragment/modal::searchJs}"></script>

    <script>
        function postAction(button, callback = null) {

            const form = button.form;
            const params = getDefaultParams();

            if (callback !== null)
                callback(params);

            let exParams = [];

            form.querySelectorAll("input").forEach(input => {
                if (input.name !== null && input.type !== "submit")
                    exParams.push(input.name);
            });
            console.log(exParams);

            Object.entries(params).forEach(([key, value]) => {
                if (exParams.includes(key)) {
                    return;
                }
                const input = document.createElement("input");
                input.setAttribute("type", "hidden");
                input.setAttribute("name", key);
                input.setAttribute("value", value);
                form.appendChild(input);
            });

            form.submit();
        }

        function getAction(link, callback = null) {
            const url = link.dataset.url;
            const params = getDefaultParams();

            if (callback !== null)
                callback(params);

            const queryString = new URLSearchParams(params).toString();
            const action = `${url}?${queryString}`;

            location.href = action;
        }

        function getDefaultParams() {
            const paramInputs = document.getElementById("params").children;
            const params = {};
            Array.from(paramInputs).forEach(input => {
                params[input.name] = input.value;
            });

            return params;
        }
    </script>
</div>
</body>
</html>